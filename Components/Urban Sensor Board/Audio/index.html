



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="iSCAPE Projects Air Pollution Sensors Technical Documentation">
      
      
        <link rel="canonical" href="https://docs.iscape.smartcitizen.me/Components/Urban Sensor Board/Audio/">
      
      
        <meta name="author" content="Smart Citizen Team">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.2, mkdocs-material-3.0.3">
    
    
      
        <title>Audio - iSCAPE Sensors Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="green">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../../../#inside-the-noise-sensor" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

  <!-- Top-level navigation -->
  <nav class="md-header-nav md-grid">
    <div class="md-flex">

      <!-- Link to home -->
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://docs.iscape.smartcitizen.me/"
            title="iSCAPE Sensors Documentation"
            class="md-header-nav__button md-logo">
          
            <img style="margin-top: -5px;" src="../../../assets/images/logo.svg" height="32" />
          
        </a>
      </div>

      <!-- Button to toggle drawer -->
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button"
            for="__drawer"></label>
      </div>

      <!-- Header title -->
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title"
            data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                iSCAPE Sensors Documentation
              </span>
              <span class="md-header-nav__topic">
                Audio
              </span>
            
          
        </div>
      </div>

      <!-- Button to open search dialogue -->
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button"
                for="__search"></label>

            <!-- Search interface -->
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>

      <!-- Repository containing source -->
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../.." title="Home" class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../Citizen Kit/Citizen Kit/" title="Citizen Kit" class="md-tabs__link">
          Citizen Kit
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../Components/" title="Components" class="md-tabs__link md-tabs__link--active">
          Components
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../Living Lab Station/Living Lab Station/" title="Living Lab Station" class="md-tabs__link">
          Living Lab Station
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../Sensor Analysis Framework/" title="Sensor Analysis Framework" class="md-tabs__link">
          Sensor Analysis Framework
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../Sensor Platform/Sensor Platform/" title="Sensor Platform" class="md-tabs__link">
          Sensor Platform
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://docs.iscape.smartcitizen.me/" title="iSCAPE Sensors Documentation" class="md-nav__button md-logo">
      
        <img src="../../../assets/images/logo.svg" width="48" height="48">
      
    </a>
    iSCAPE Sensors Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../mk-ref/" title="MK reference" class="md-nav__link">
      MK reference
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Citizen Kit
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Citizen Kit
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Citizen Kit/Citizen Kit/" title="Citizen Kit" class="md-nav__link">
      Citizen Kit
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Components
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Components
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../Components/" title="Components" class="md-nav__link">
      Components
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2">
    
    <label class="md-nav__link" for="nav-4-2">
      Data Board
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        Data Board
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../Data Board/Data Board/" title="Data Board" class="md-nav__link">
      Data Board
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3" type="checkbox" id="nav-4-3">
    
    <label class="md-nav__link" for="nav-4-3">
      Firmware
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-3">
        Firmware
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../Firmware/Firmware/" title="Firmware" class="md-nav__link">
      Firmware
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3-2" type="checkbox" id="nav-4-3-2">
    
    <label class="md-nav__link" for="nav-4-3-2">
      Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-3-2">
        Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../Firmware/guides/Debug the firmware/" title="Debug the firmware" class="md-nav__link">
      Debug the firmware
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Firmware/guides/Edit the Firmware/" title="Edit the Firmware" class="md-nav__link">
      Edit the Firmware
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Firmware/guides/Update the firmware/" title="Update the firmware" class="md-nav__link">
      Update the firmware
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-4" type="checkbox" id="nav-4-4">
    
    <label class="md-nav__link" for="nav-4-4">
      Gas Pro Sensor Board
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-4">
        Gas Pro Sensor Board
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../Gas Pro Sensor Board/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Gas Pro Sensor Board/Electrochemical Sensors/" title="Electrochemical Sensors" class="md-nav__link">
      Electrochemical Sensors
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-4-3" type="checkbox" id="nav-4-4-3">
    
    <label class="md-nav__link" for="nav-4-4-3">
      Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-4-4-3">
        Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../Gas Pro Sensor Board/guides/Advanced setup/" title="Advanced setup" class="md-nav__link">
      Advanced setup
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-5" type="checkbox" id="nav-4-5">
    
    <label class="md-nav__link" for="nav-4-5">
      PM Sensor Board
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-5">
        PM Sensor Board
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../PM Sensor Board/PM Sensor Board/" title="PM Sensor Board" class="md-nav__link">
      PM Sensor Board
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../PM Sensor Board/Plantower PMS/" title="Plantower PMS" class="md-nav__link">
      Plantower PMS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-6" type="checkbox" id="nav-4-6" checked>
    
    <label class="md-nav__link" for="nav-4-6">
      Urban Sensor Board
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-6">
        Urban Sensor Board
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Audio
      </label>
    
    <a href="./" title="Audio" class="md-nav__link md-nav__link--active">
      Audio
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basic-concepts-and-theory" title="Basic Concepts and theory" class="md-nav__link">
    Basic Concepts and theory
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basics-of-mems-i2s-microphone" title="Basics of MEMs I2S Microphone" class="md-nav__link">
    Basics of MEMs I2S Microphone
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#i2s-protocol" title="I2S Protocol" class="md-nav__link">
    I2S Protocol
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#basics-of-weighting-and-human-hearing" title="Basics of weighting and human hearing" class="md-nav__link">
    Basics of weighting and human hearing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rms-and-fft-algorithm-simplified" title="RMS and FFT algorithm simplified" class="md-nav__link">
    RMS and FFT algorithm simplified
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prepost-processing-signal-windowing-and-equalisation" title="Pre/post processing: signal windowing and equalisation" class="md-nav__link">
    Pre/post processing: signal windowing and equalisation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#signal-windowing" title="Signal windowing" class="md-nav__link">
    Signal windowing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equalisation" title="Equalisation" class="md-nav__link">
    Equalisation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15-filtering-and-convolution" title="1.5 Filtering and convolution" class="md-nav__link">
    1.5 Filtering and convolution
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#afsk-analyser" title="AFSK Analyser" class="md-nav__link">
    AFSK Analyser
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-via-sound" title="Configuration via sound" class="md-nav__link">
    Configuration via sound
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#firmware-implementation" title="Firmware implementation" class="md-nav__link">
    Firmware implementation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samd21-cortex-m0-implementation" title="SAMD21 Cortex M0+ implementation" class="md-nav__link">
    SAMD21 Cortex M0+ implementation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../MICS/" title="MICS" class="md-nav__link">
      MICS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Urban Sensor Board/" title="Urban Sensor Board" class="md-nav__link">
      Urban Sensor Board
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Living Lab Station
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Living Lab Station
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Living Lab Station/Living Lab Station/" title="Living Lab Station" class="md-nav__link">
      Living Lab Station
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Sensor Analysis Framework
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Sensor Analysis Framework
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Sensor Analysis Framework/" title="Index" class="md-nav__link">
      Index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Sensor Analysis Framework/Calibration/" title="Calibration" class="md-nav__link">
      Calibration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-3" type="checkbox" id="nav-6-3">
    
    <label class="md-nav__link" for="nav-6-3">
      Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-3">
        Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Sensor Analysis Framework/guides/Install the framework/" title="Install the framework" class="md-nav__link">
      Install the framework
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Sensor Analysis Framework/guides/Stations data post processing/" title="Welcome to MkDocs" class="md-nav__link">
      Welcome to MkDocs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Sensor Platform
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Sensor Platform
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Sensor Platform/Sensor Platform/" title="Sensors Platform" class="md-nav__link">
      Sensors Platform
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7-2" type="checkbox" id="nav-7-2">
    
    <label class="md-nav__link" for="nav-7-2">
      Guides
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-7-2">
        Guides
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Sensor Platform/guides/Onboarding Sensors/" title="Onboarding Sensors" class="md-nav__link">
      Onboarding Sensors
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../Sensor Platform/guides/Uploading CSV Data/" title="Uploading CSV Data" class="md-nav__link">
      Uploading CSV Data
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basic-concepts-and-theory" title="Basic Concepts and theory" class="md-nav__link">
    Basic Concepts and theory
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basics-of-mems-i2s-microphone" title="Basics of MEMs I2S Microphone" class="md-nav__link">
    Basics of MEMs I2S Microphone
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#i2s-protocol" title="I2S Protocol" class="md-nav__link">
    I2S Protocol
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#basics-of-weighting-and-human-hearing" title="Basics of weighting and human hearing" class="md-nav__link">
    Basics of weighting and human hearing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rms-and-fft-algorithm-simplified" title="RMS and FFT algorithm simplified" class="md-nav__link">
    RMS and FFT algorithm simplified
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prepost-processing-signal-windowing-and-equalisation" title="Pre/post processing: signal windowing and equalisation" class="md-nav__link">
    Pre/post processing: signal windowing and equalisation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#signal-windowing" title="Signal windowing" class="md-nav__link">
    Signal windowing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equalisation" title="Equalisation" class="md-nav__link">
    Equalisation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15-filtering-and-convolution" title="1.5 Filtering and convolution" class="md-nav__link">
    1.5 Filtering and convolution
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#afsk-analyser" title="AFSK Analyser" class="md-nav__link">
    AFSK Analyser
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-via-sound" title="Configuration via sound" class="md-nav__link">
    Configuration via sound
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#firmware-implementation" title="Firmware implementation" class="md-nav__link">
    Firmware implementation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samd21-cortex-m0-implementation" title="SAMD21 Cortex M0+ implementation" class="md-nav__link">
    SAMD21 Cortex M0+ implementation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="inside-the-noise-sensor">Inside the Noise Sensor<a class="headerlink" href="#inside-the-noise-sensor" title="Permanent link">Link</a></h1>
<h2 id="basic-concepts-and-theory">Basic Concepts and theory<a class="headerlink" href="#basic-concepts-and-theory" title="Permanent link">Link</a></h2>
<h3 id="basics-of-mems-i2s-microphone">Basics of MEMs I2S Microphone<a class="headerlink" href="#basics-of-mems-i2s-microphone" title="Permanent link">Link</a></h3>
<p>The new Smart Citizen Kit 2.0 comes with a digital <strong>MEMs I2S microphone</strong>. There is a wide range of possibilities in the market, and our pick was the INVENSENSE (now TDK) <a href="https://www.invensense.com/products/digital/ics-43432/">ICS43432</a>: a tiny digital MEMs microphone with I2S output. There is an extensive documentation at TDK's website coming from the former and we would recommend to review the nicely put documents for those interested in the topic.</p>
<div style="text-align:center">
<img src ="https://i.imgur.com/ZbkN4aj.png" alt="Invensense ICS43432" class="cover"/>
</div>

<p><em>Image credit: <a href="https://www.invensense.com/products/digital/ics-43432">Invensense ICS43432</a></em></p>
<p>To begin with, we'll talk about the microphone itself. The <strong>MEMs microphone</strong> comes with a transducer element which converts the sound pressure into electric signals. The sound pressure reaches the transducer through a hole drilled in the package and the transducer's signal is sent to an ADC which provides with a signal which can be pulse density modulated (PDM) or in I2S format. Since the ADC is already in the microphone, we have an all-digital audio capture path to the processor and it’s less likely to pick up interferences from other RF, such as the WiFi, for example. The I2S has the advantage of a decimated output, and since the SAMD21 has an I2S port, this allows us to connect it directly to the microcontroller with no CODEC needed to decode the audio data. Additionally, there is a bandpass filter, which eliminates <em>DC</em> and low frequency components (i.e. at fs = 48kHz, the filter has -3dB corner at 3,7Hz) and high frequencies at <em>0,5·fs</em> (-3dB cutoff). Both specifications are important to consider when analysing the data and discarding unusable frequencies. The microphone acoustic response has to be considered as well, with subsequent equalisation in the data treatment in order. We will review these points on dedicated sections.</p>
<div style="text-align:center">
<img src ="https://i.imgur.com/cToxGKY.png" alt="ICS43432 Datasheet" class="cover"/>
</div>

<p><em>Image credit: <a href="https://www.invensense.com/wp-content/uploads/2015/02/ICS-43432-data-sheet-v1.3.pdf">ICS43432 Datasheet - TDK Invensense</a></em></p>
<h4 id="i2s-protocol">I2S Protocol<a class="headerlink" href="#i2s-protocol" title="Permanent link">Link</a></h4>
<p>The <strong><a href="https://www.sparkfun.com/datasheets/BreakoutBoards/I2SBUS.pdf">I2S protocol</a></strong> (<em>Inter-IC-Sound</em>) is a serial bus interface which consists of: a bit clock line or Serial Clock (<em>SCK</em>), a word clock line or Word Select (<em>WS</em>) and a multiplexed Serial Data line (<em>SD</em>). The SD is transmitted in two’s complement with MSB first, with a 24-bit word length in the microphone we picked. The <em>WS</em> is used to indicate which channel is being transmitted (left or right). In the case of the ICS43432, there is an additional pin which corresponds with the L/R, allowing to use the left or right channel to output the signal and the use of stereo configurations. When set to left, the data follows WS’s falling edge and when set to right, the WS’s rising edge. For the SAMD21 processor, there is a well developed <a href="https://github.com/arduino/ArduinoCore-samd/tree/master/libraries/I2S">I2S library</a> that will take control of this configuration. </p>
<div style="text-align:center">
<img src ="https://i.imgur.com/Z6TdV9h.png" alt="ICS43432 Datasheet" class="cover"/>
</div>

<p><em>Image credit: <a href="https://www.sparkfun.com/datasheets/BreakoutBoards/I2SBUS.pdf">I2S bus specification - Philips Semiconductors</a></em></p>
<p>To finalise, we would like to highlight that the SD line of the I2S protocol is quite delicate at high frequencies and it is largely affected by noise in the path the line follows. If you want to try this at home (for example with an Arduino Zero and an I2S microphone like <a href="https://www.tindie.com/products/onehorse/ics43432-i2s-digital-microphone/">this one</a>, it is important not to use cables in this line and to connect the output pin directly to the board, to avoid having interfaces throughout the SD line. One interesting way to see this is that every time the line sees a medium change, part of it will be reflected and part will be transmitted, just like any other wave. This means that introducing a cable for the line will provoke at least three medium changes and a potential signal quality loss much higher than a direct connection. Apart from this point, the I2S connection is pretty straight forward and it is reasonably easy to retrieve data from the line and start playing around with some FFT analysis.</p>
<h3 id="basics-of-weighting-and-human-hearing">Basics of weighting and human hearing<a class="headerlink" href="#basics-of-weighting-and-human-hearing" title="Permanent link">Link</a></h3>
<p>The world of acoustics and signal processing for audio analysis is worth several book-length discussions. We might as well try to give an insight of our intentions within this world since we introduced ourselves in it by picking a digital microphone with a quite nice range of capabilities. </p>
<p>The very first thing we would like to do is to be able to perform <strong>weighting</strong> on the buffer we receive from the microphone through the I2S. To explain a bit further on what <em>weighting</em> is, it is no more than a transformation from the real-world sound pressure levels (SPL) travelling around in the air to what our ears can perceive. Just that.</p>
<div style="text-align:center">
<img src ="http://www.dspguide.com/graphics/F_22_1.gif" alt ="Ear model"> 
</div>

<p><em>Image credit: <a href="http://www.dspguide.com/ch22/1.htm">Human hearing - DSP Guide</a></em></p>
<p>There are several studies and models of what we actually perceive and depending on them, we have several types of the so called <strong>weighting functions</strong>. Some of them have been standarised for the purpose of SPL measurement, finding different types like <strong><a href="https://en.wikipedia.org/wiki/A-weighting#Deficiencies_of_A-weighting">A-weighting</a></strong> (the most common one), B-weighting, D (both in disuse) and others. In the frequency domain, they look like this:</p>
<div style="text-align:center">
<img src ="https://upload.wikimedia.org/wikipedia/commons/thumb/3/39/Acoustic_weighting_curves_%281%29.svg/400px-Acoustic_weighting_curves_%281%29.svg.png" alt="Weighting table">
</div>

<p><em>Image credit: <a href="https://en.wikipedia.org/wiki/A-weighting#Deficiencies_of_A-weighting">A-weighting - Wikipedia</a></em></p>
<p>This means that, even if the are high sound pressure levels floating around in the air, we might not hear them just because of the frequency they are at. Normally humans can hear from something around 20Hz to 20kHz, although most adults might not hear anything in out-of-laboratory conditions above 15kHz. Some animals though, can perceive a <a href="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/Animal_hearing_frequency_range.svg/512px-Animal_hearing_frequency_range.svg.png">great range of frequencies</a>, and for example mouses can hear up to 80kHz! So, now we know what this all is about, the I2S microphone is going to help us understand better how <a href="http://www.bbc.com/earth/story/20150120-mystery-squeaks-of-beluga-whales"><em>beluga whales</em> communicate among themselves</a>... </p>
<p>But also! The I2S microphone is interesting in order to <strong>understand sources of urban noise pollution</strong> since it provides us with a raw SPL buffer we can play with. As well, we can obtain dBA levels (SPL with a-weighting correction) by processing this buffer in several ways and calculate the RMS level of the resulting signal. In the <strong>Part II</strong> we will go through the mathematics of the signal processing itself and talk a bit about FFT, signal filtering and some other geeky stuff!</p>
<h3 id="rms-and-fft-algorithm-simplified">RMS and FFT algorithm simplified<a class="headerlink" href="#rms-and-fft-algorithm-simplified" title="Permanent link">Link</a></h3>
<p>In this paragraph we'll continue with some bits and pieces about <em>acoustics and signal processing</em> we started talking about in section 1.2. We are going to talk about the <em>mathematics</em> behind these applications and how we'll use them in the signal processing for obtaining our <em>weighting</em> for the SCK.</p>
<p>In the previous section we introduced the concept of <em>weighting</em> and our interest on calculating the <em>sound pressure level</em> in different scales. Normally, SPL is expressed in <strong>RMS</strong> levels, or <em>root mean square</em>. This is nothing more than a modified arithmetic average, where each term of the expression is added in its square form. Therefore, to keep the same units, we then take the square root of all the average and we have:</p>
<div>
<div class="MathJax_Preview">
x = {\sqrt{x_1^2+x_2^2+...+x_N^2 \over N}}
</div>
<script type="math/tex; mode=display">
x = {\sqrt{x_1^2+x_2^2+...+x_N^2 \over N}}
</script>
</div>
<p>The interesting thing about the RMS level, is that it expresses an average signal level throughout the signal, and it actually relates to the peak level of sinusoid wave by √2. Therefore, it is a very interesting way to express average levels for signals and for that reason, it's the common standard used.</p>
<div style="text-align:center">
<img src ="https://upload.wikimedia.org/wikipedia/commons/thumb/8/89/Sine_wave_voltages.svg/400px-Sine_wave_voltages.svg.png" alt ="Sine wave parameters"> 
</div>

<p><em>Image credit: <a href="https://upload.wikimedia.org/wikipedia/commons/thumb/8/89/Sine_wave_voltages.svg/400px-Sine_wave_voltages.svg.png">Sine wave parameters- Wikipedia</a></em></p>
<p>Now that we know how to calculate the RMS level of our signal, let's go into something more interesting: <em>how do we actually perform the weighting?</em> Well, if you recall the previous section, when we talked about hearing, we were talking about the different hearing capabilities in terms of <strong>frequencies</strong> (in humans, mouses, beluga whales... ). Therefore, something interesting to know about our signal is its <strong>frequency content</strong>,  so that we are able to perform the weighting. For this purpose, we have the <strong>FFT algorithm</strong>, which we won't tell you is easy, but we'll try to put it simply here.</p>
<p>So <em>FFT</em> stands for <strong>Fast Fourier Transform</strong>, and it's an algorithm capable of performing a Fourier Transform in a simplified and efficient way (that's where the <em>fast</em> comes in). What it does in a detailed mathematical way is something quite complicated and we don't want to bore you and ourselves with the details; but being practical, it is basically a convertion between the signal in time domain and its frequency domain components. Interestingly, this process is reversible and the other way around it is called <strong>IFFT</strong> (<em>I</em> for <em>Inverse</em>, obviously...).</p>
<div style="text-align:center">
<img src ="https://i.imgur.com/1B1MZSF.png?1" alt ="Sine wave frequency convertion"> 
</div>

<p><em>Image credit: Smart Citizen</em></p>
<p>In the example above, things in the time domain get a bit messy, but in the frequency domain we can <em>clearly</em> see the composition of two sine waves of the same amplitude of roughly 40Hz and 120Hz. The FFT algorithm hence helps us digest the information contained in a signal in a more visually understandable way.</p>
<p>We will cover more details about the process and it's implementation in future sections. For this introduction, let's move on to what we actually want to do: <em>the much anticipated weighting</em>. At this point, our task is fairly easy: we just have to multiply both: our signal in the frequency domain with the weighting function and that's it! If we have a look at the figure below, in the time and frequency domain, the signals look like this:</p>
<div style="text-align:center">
<img src ="https://i.imgur.com/3REv8Ah.png?1" alt ="White noise frequency convertion"> 
</div>

<p><em>Image credit: Smart Citizen</em></p>
<p>This example shows how our ears are only capable of perceiving the signal in red, but the actual sound components are in blue -- being much higher in the amplitude spectrum. If you want to get into the thick of it, here you have the actual <a href="https://github.com/oscgonfer/AudioI2S_SCK/tree/master/OCTAVE/A_WEIGHTING">implementation in Matlab</a> of the A-weighting function that we'll use in the SCK V2.0.</p>
<p>And finally, to close, let's take a look at the whole chain of processing, where we will continue in future sections:</p>
<pre class="uml-flowchart"><code>st=&gt;start: Signal acquisition
e=&gt;end: RMS calculation
op=&gt;operation: Windowing
op2=&gt;operation: FFT
op3=&gt;operation: Spectrum Normalisation
op4=&gt;operation: Equalisation
op5=&gt;operation: A-weighting

st-&gt;op-&gt;op2-&gt;op3-&gt;op4-&gt;op5-&gt;e</code></pre>

<p><em>Image credit: Smart Citizen</em></p>
<p>This is the whole signal treatment process we use for the I2S microphone ICS43432. We will have a look at <em>windowing</em> and its use in future sections, as well as its implementation in the SAMD21 Cortex M0+ for our firmware.</p>
<p><span><span class="MathJax_Preview">NB</span><script type="math/tex">NB</script></span>: Being mathematical purist, there is yet another possibility for this procedure using convolution in time domain, which we will cover in future sections.</p>
<h3 id="prepost-processing-signal-windowing-and-equalisation">Pre/post processing: signal windowing and equalisation<a class="headerlink" href="#prepost-processing-signal-windowing-and-equalisation" title="Permanent link">Link</a></h3>
<h4 id="signal-windowing">Signal windowing<a class="headerlink" href="#signal-windowing" title="Permanent link">Link</a></h4>
<p>In this section we are going to describe how we have to pre-post process our signals in order to obtain the results in the manner we are expecting. These are very important steps in our processing chain, since the FFT algorithms -or convolution FIR Filters- won't be able to cope with our system's limitations. These limitations might not be obvious at the beginning, but you really don't want to ignore them while designing your system, since they'll invalidate many of your measurements. If this sounds <em>greek</em> to you, consider reading <a href="https://forum.smartcitizen.me/t/a-bit-of-acoustics-and-signal-processing-for-audio-part-i/925">Part I</a> and <a href="https://forum.smartcitizen.me/t/a-bit-of-acoustics-and-signal-processing-for-audio-part-ii/927">Part II</a> in this forum before continuing with this post.</p>
<p>The very first of these limitations, is the fact that our microphone is, in fact, taking <strong>discrete samples</strong> of the ambient noise surrounding it. This means that, from the very beginning, we are missing some pieces of information and we will never be able to process them. But it's OK! For the purpose of our analysis, we don't need to sample continuosly and this situation is easily bypassed. </p>
<p><img alt="Discrete sampling" src="https://i.imgur.com/3Iz2tE0.png" /></p>
<p><em>Image credit: <a href="https://www.nutaq.com/blog/analog-digital-%E2%80%93-part-2-conversion-process">NUTAQ - Signal processing</a></em></p>
<p>Discrete sampling has two main consequences for us: the first one is that we are taking samples once every <span><span class="MathJax_Preview">1/f_s</span><script type="math/tex">1/f_s</script></span>, where <span><span class="MathJax_Preview">f_s</span><script type="math/tex">f_s</script></span> is the sampling frequency. Normal audio systems sample at 44,1kHz, but this number might vary depending on the application. If you remember <a href="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/Animal_hearing_frequency_range.svg/512px-Animal_hearing_frequency_range.svg.png">this chart</a>, you might be wondering why we have to sample at such a high frequency. </p>
<div style="text-align:center">
<img src ="https://www.adinstruments.com/sites/default/files/wysiwyg-resources/images/data-quality-digital-sampling_0.gif">
</div>

<p><em>Image credit: <a href="https://www.adinstruments.com/">Signal acquisition - Adinstruments</a></em></p>
<p>This is due to the <a href="https://en.wikipedia.org/wiki/Nyquist%E2%80%93Shannon_sampling_theorem">Nyquist sampling criterion</a>, which states that <strong>at a minimum, we have to sample at double the maximum frequency we want to analyse</strong>. Since humans hearing has a limited frequency range that goes up to 20kHz in some cases, it is reasonable to use something around 40kHz. With this, the <em>Nyquist criterion</em> solves the so called <strong>aliasing problem</strong>, in which several sinusoid signals could fit the same sampling pattern if the number of samples is too low:</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/28/AliasingSines.svg/1200px-AliasingSines.svg.png" alt="AliasingSines.svg"></img></p>
<p><em>Image credit: <a href="https://en.wikipedia.org/wiki/Aliasing">Wikipedia - Aliasing</a></em></p>
<p>The second of the discrete sampling limitation comes from the <strong>amount of samples we are able to handle at a time</strong>. Normally, this is due to memory limitations in the RAM, although we'll see in the future where to allocate them. Nevertheless, it is not useful to handle buffers that are <em>too long</em>, since at some point, the increase of buffer length does not provide any additional information. Buffer length requirements in our case come from the minimum frequency we want to sample, which is <em>around 20Hz</em>. Doing some quick math, we need 0,05s worth of sample buffer, which at 44,1kHz is roughly <em>2200 samples</em>. This is equally too many samples, considering that each could be allocated as a <code class="codehilite">uint8_t</code>, taking up to 16kB just for the raw buffer!</p>
<p>This is where <strong>signal windowing</strong> kicks in. Imagine that we have a very-low-frequency sinusoid and that we are not able to sample completely the whole sine wave, due to buffer limitations. By definition, our system is assuming that the discrete samples we measure are constantly being repeated in the environment, one after the other:</p>
<div style="text-align:center">
<img src= "https://i.imgur.com/DOfCeAI.png?1">
</div>

<p><em>Image credit: Smart Citizen</em></p>
<p>When we take the FFT of this signal, we see undesired frequencies that make our frequency spectrum invalid. This is called <strong>spectral leakage</strong> and it's mitigated by the use of <a href="https://en.wikipedia.org/wiki/Window_function"><em>windows</em></a> (math funcions, not the OS). These windows operate by <strong>smoothing the edges</strong> of our measurement and preventing the <em>jumps</em> in the signal helping the FFT algorithm to properly analyse the signals.</p>
<div style="text-align:center">
<img src= "https://i.imgur.com/1BSCYdu.png">
</div>

<p><em>Image credit: Smart Citizen</em></p>
<p>With the use of <em>signal windowing</em>, more specifically with the use of the <em>hamming window</em>, we are then able to reduce the amount of samples needed to roughly 1000 samples. Now we are down to <strong>50% of the memory allocation needed without windowing</strong>. You can see the effect on the <em>RMS relative errors</em> in the image below, where the trend of the Hann (another common window) and the Hamming treated buffers, with respect to the frequency tends to stabilise <em>much more quickly</em> than the <em>raw</em> buffers.</p>
<div style="text-align:center">
<img src= "https://i.imgur.com/rlmh9jf.png">
</div>

<p><em>Image credit: Smart Citizen</em></p>
<p>There is a wide range of functions to use and the decision depends on your application. For audio applications, the most common ones are the Hann, Hamming, and Blackmann. We chose the Hamming because it's trend is to stabilise a bit more quickly than the rest, although the differencies are minimal. For your reference, there is a very interesting description of all these phenomena in this <a href="http://www.ni.com/white-paper/4278/en/">article</a>, where you'll find a more mathematical approach.</p>
<h4 id="equalisation">Equalisation<a class="headerlink" href="#equalisation" title="Permanent link">Link</a></h4>
<p>:::info
Talk about the microphone response and how to correct it.
:::</p>
<h3 id="15-filtering-and-convolution">1.5 Filtering and convolution<a class="headerlink" href="#15-filtering-and-convolution" title="Permanent link">Link</a></h3>
<p>In this section we are going to talk about a different approach to the FFT Analysis we have seen in previous sections. <em>What if</em> we don't like the FFT algorithm and we only want to obtain a dBA or dBC results? There is a fairly simple solution to this problem, and it's called <strong>filtering</strong>.</p>
<p>Filtering is a very common technique in signal acquisition that eliminates some frequency components of the raw signal. Examples of filters you very likely have heard of are <em>low-pass, high-pass  and band-pass filters</em>. These only <em>let pass</em> the low, high or a defined interval range of frequencies, mostly cancelling out the rest. In the frequency domain, they basicly multiply the spectrum of our signal with its filter spectrum. Exactly what we have done with the weighting.</p>
<p><img alt="" src="https://www.norwegiancreations.com/wp-content/uploads/2016/03/filters.png" /></p>
<p><em>Image credit: Norwegian Creations</em></p>
<p>First, it is important to get a glimpse of the math behind the filters and why they do their magic. And for this, the most important thing we need to know is called <strong>convolution</strong>.</p>
<div style="text-align:center">
<img src= "http://colah.github.io/posts/2014-07-Understanding-Convolutions/img/RiverTrain-ImageConvDiagram.png">
</div>

<p><em>Image credit: <a href="http://intellabs.github.io/RiverTrail/tutorial/">River Trail</a></em></p>
<p>For the purpose of <strong>audio analysis</strong>, let's consider we have an input vector, a filter kernel and an output vector. Our input vector can be the raw audio signal we have captured, being the output signal the result of the convolution operation. The filter kernel is the characteristic of the filter and will be, for this example, a one dimension array. What the convolution operation is going to do, in a <em>very very very simplified way</em>, is to <strong>sweep through the input sample</strong> and multiply each component with it's corresponding filter kernel component, then sum the results and put them in the corresponding output sample. If we put some math notation and call <em>x[n]</em> to the input vector, <em>h[n]</em> to the filter kernel and <em>y[n]</em> to the output vector, it all ends up looking like this:</p>
<div style="text-align:center">
    <img src = "http://www.dspguide.com/graphics/F_6_8.gif">
</div>

<p><em>Image credit: <a href="http://www.dspguide.com/">DSP Guide</a></em></p>
<p>Now, the most interesting thing of all this theory is that <strong>convolution and multiplication are equivalent operations when we jump from the time to the frequency domain</strong>. This means that multiplication in time domain equals to convolution in frequency domain, and more importantly for us, <strong>convolution in the time domain, equals to multiplication in the frequency domain</strong>. To sum up, the relationship between both domains would look like:</p>
<div style="text-align:center">
    <img src = 
"https://i.imgur.com/3Bhyqt3.png">
</div>

<p><em>Image credit: SmartCitizen</em></p>
<p>Therefore, what we could do is to define a <strong>custom filter function</strong> and apply it via convolution to our input buffer. This is basically a <strong>FIR filter</strong>, where <em>FIR</em> stands for <em>Finite Impulse Response</em>. There is another type of filters called <strong>IIR</strong>, where <em>IIR</em> stands for <em>Infinite impulse response</em>. The difference between them is that <em>FIR uses convolution</em> and <em>IIR uses recursion</em>. The concept of <strong>recursion</strong> is very simple and it's nothing else than a simplification of the convolution, given that in the convolution algorithm, there are many <em>recursive</em> operations that we repeat over an over and we can implement into a smarter algorithm. Normally, IIR filters are <em>more efficient in terms of speed and memory</em>, but we need to specify a series of coefficients, and it's tricky, if not impossible, to create a custom filter response.</p>
<div style="text-align:center">
    <img src = "http://www.dspguide.com/graphics/F_19_1.gif">
</div>

<p><em>Image credit: <a href="http://www.dspguide.com/">DSP Guide</a></em></p>
<p>So finally! <em>How can we avoid using the FFT algorithm to extract the desired frequency content of a signal and recreate the signal without it?</em> Sounds complex, but now we know that  we can use a <strong>FIR filter</strong>, with a <strong>custom frequency response</strong> and apply it via convolution to our input buffer. As simple as that. The custom frequency response, with the proper math, can be optained by applying the IFFT algorithm to the desired frequency response (for example, the A-weighting function). You can have a look to <a href="https://github.com/oscgonfer/AudioI2S_SCK/tree/dev_i2s_dbg/OCTAVE">this example</a> if you want to create a custom filter function in <a href="https://www.gnu.org/software/octave/">octave</a>, with A or C weighting and implement it to a FIR filter in C++.</p>
<div style="text-align:center">
    <img src = 
"https://i.imgur.com/MDJgGeH.png">
</div>

<p><em>Image credit: SmartCitizen</em></p>
<p>Also, if you are really into it, you can read more about convolution and other DSP topics, we would recommended to go through <a href="http://www.dspguide.com/ch6.htm">this fantastic guide</a>.</p>
<h3 id="afsk-analyser">AFSK Analyser<a class="headerlink" href="#afsk-analyser" title="Permanent link">Link</a></h3>
<p>In this section we are going to talk about a new feature we are planning to introduce in the upcoming version of the SCK: a FSK communication protocol via Audio (A-FSK). You might have read about this technique and it’s usage in the Amazon Dash configuration process, and on the post today we are going to describe very briefly the work in progress for this feature.</p>
<p>So! FSK stands for Frequency Shift Keying, which is a form of transmission through frequency variations on the carrying waveforms. It’s major counterpart is the so called ASK, or Amplitude Shift Keying, in which the transmission is carried out via amplitude variations. A very simple form of ASK is OOK, which stands for On-Off-Keying, in which the amplitude of the carrier wave oscillates between a value and nothingness:</p>
<div style="text-align:center">
    <img src = 
"https://i.stack.imgur.com/zKLVY.gif">
</div>

<p><em>Image credit: Electric Stack Exchange</em></p>
<p>As in many other situations, there is a trade off between the options on the table: ASK or FSK? Maybe another one? The main disadvantage of ASK it is said to have a higher probability of error with respect to FSK, since noise interference affects amplitude of the transmitted wave. FSK, on the other hand, it is said to have a lower bandwidth efficiency. However, since we have talked about FFT quite a lot now, we thought FSK would be our best bet and also, because maybe bandwidth is not such a big deal after all as we can see below.</p>
<p>Then, the idea is to implement an algorithm that is able to identify if the sound transmitted from an emitter (i.e. a smartphone) contains a series of reference frequencies in certain known spots. Following this principle, our aim is to transmit a byte per sound wave, hence, in a sound wave containing up to 8 possible carrier frequencies that might or not be activated. The activation (or not) of these frequencies in the analysed spectrum will yield a 1 or a 0, that we can use on a bit mask and extract <a href="https://www.sciencebuddies.org/science-fair-projects/references/table-of-8-bit-ascii-character-codes">8-bit ASCII characters codes</a>:</p>
<div style="text-align:center">
    <img src = 
"https://martinmelhus.com/content/images/2017/09/spectrum-1.png">
</div>

<p><em>Image credit: <a href="https://martinmelhus.com/">Martin Melhus</a></em></p>
<p>The emitter could be based on the Web Audio API, as the example from Martin Melhus above from his project on a Web Audio Modem. Finally, the receiver would be our beloved I2S Mems microphone that we have been talking about for so long now, doing a FFT algorithm and detecting the peaks in it, identifying the carrier frequencies activation.</p>
<h3 id="configuration-via-sound">Configuration via sound<a class="headerlink" href="#configuration-via-sound" title="Permanent link">Link</a></h3>
<p>:::info
*   <a href="http://www.blog.jay-greco.com/wp/?p=116">Reverse engineering the amazon dash</a>
    *   <a href="https://github.com/jaygreco/Amazon-Dash-Decoder/tree/master/MATLAB">MATLAB CODE</a>
*   <a href="https://hackaday.com/2017/10/18/a-web-based-modem/">Web-based modem</a>
*    <a href="https://en.wikipedia.org/wiki/Amplitude-shift_keying">ASK - Amplitude Shift Keying</a>
*    <a href="http://www.dspguide.com/ch26/1.htm">DSP fundamentals</a>
*    <a href="https://en.wikipedia.org/wiki/Hilbert_transform">Hilbert transform</a>
:::</p>
<h2 id="firmware-implementation">Firmware implementation<a class="headerlink" href="#firmware-implementation" title="Permanent link">Link</a></h2>
<h3 id="samd21-cortex-m0-implementation">SAMD21 Cortex M0+ implementation<a class="headerlink" href="#samd21-cortex-m0-implementation" title="Permanent link">Link</a></h3>
<p>Two libraries:</p>
<p><strong><a href="https://github.com/oscgonfer/AudioI2S">AudioI2S</a></strong>
Base library, intented to be generic purpose audio analysis library for an I2S Microphone on the SAMD21 with:</p>
<ul>
<li>FFT Analysis</li>
<li>FIR Analysis</li>
<li>Custom window selection</li>
<li>Custom weighting function selection</li>
<li>Custom buffer size and custom fft bin size (in case of FFT analyser)</li>
<li>Custom equalisation</li>
<li>Octave auto generation of .h files for coefficients and so on</li>
</ul>
<p><strong><a href="https://github.com/fablabbcn/smartcitizen-kit-audio">smartcitizen-kit-audio</a></strong>
Library intented for firmware implementation in the SmartCitizen kit 2.0, with a better usage of memory and SCK related functionalities:</p>
<ul>
<li>FFT analysis</li>
<li>Selection of A or C weighting through LUT</li>
<li>Two user cases:<ul>
<li>General audio analysis (sensorRead) with fixed buffer size and fixed FFT bins size (fs = 44,1kHz)</li>
<li>Audio Communication with FSK - with information transfer via audio</li>
</ul>
</li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->



<!-- Application footer -->
<footer class="md-footer">

  <!-- Link to previous and/or next page -->
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">

        <!-- Link to previous page -->
        
          <a href="../../PM Sensor Board/Plantower PMS/"
              title="Plantower PMS"
              class="md-flex md-footer-nav__link md-footer-nav__link--prev"
              rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back
                    md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch
                  md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Plantower PMS
              </span>
            </div>
          </a>
        

        <!-- Link to next page -->
        
          <a href="../MICS/"
              title="MICS"
              class="md-flex md-footer-nav__link md-footer-nav__link--next"
              rel="next">
            <div class="md-flex__cell md-flex__cell--stretch
                  md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                MICS
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward
                    md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  

  <!-- Further information -->
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">

      <!-- Copyright and theme information -->
      <div class="md-footer-copyright">
		        <img style="margin-top: 20px" alt="The iSCAPE project has received funding from the European Community’s H2020 Programme under Grant Agreement No. 689954." src="/assets/images/eu-flag.png">
         		<p class="md-footer-copyright__highlight">The iSCAPE project has received funding from the European Community’s H2020 Programme under Grant Agreement No. 689954.</p>
              	Contribute at <a href="https://github.com/fablabbcn/smartcitizen-iscape-docs">smartcitizen-iscape-docs</a>
      </div>

      <!-- Social links -->
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.583bbe55.js"></script>
      
      <script>app.initialize({version:"1.0.2",url:{base:"../../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
    
      
    
  </body>
</html>